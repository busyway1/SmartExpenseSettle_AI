def get_tax_invoice_prompt(text: str, file_name: str = "", page_number: int = None) -> str:
    """세금계산서 분석 프롬프트 생성 (개선된 버전)"""
    base_prompt = f"""
다음은 세금계산서 문서입니다. 이는 개별 문서이므로 해당 문서에서만 정보를 추출해주세요.

문서 내용:
{text}

"""
    
    # 페이지 번호 정보 추가
    page_info = f"**현재 페이지 번호: {page_number}**" if page_number is not None else ""
    
    return base_prompt + f"""
이 세금계산서에서 **다음 9개 필드만** 정확히 추출해주세요.

{page_info}

**중요: 여러 개의 세금계산서가 있는 경우**
- 승인번호가 다른 세금계산서는 각각 개별 문서로 취급해주세요
- 각 세금계산서마다 페이지 번호를 반드시 포함해주세요
- 배열 형태로 각 개별 세금계산서의 정보를 모두 출력해주세요

**추출할 필드 (9개만):**

1. **승인번호**: 
   - 세금계산서 승인번호 (문서 식별자)
   - 형태: 숫자 조합 (예: 202401234567890)
   - 승인번호가 없는 경우 "정보 없음"

2. **공급가액**: 
   - 공급가액 합계 (합계금액은 공급가액이 아님에 유의)
   - 형태: 숫자 (쉼표 포함 가능)
   - 단위: 원 (예: 1,000,000)
   - "공급가액 합계" 또는 "공급가액계" 라벨 확인

3. **부가세액**: 
   - 세액 합계
   - 형태: 숫자 (쉼표 포함 가능)
   - 단위: 원 (예: 100,000)
   - "세액 합계" 또는 "부가세액" 라벨 확인

4. **공급자상호**: 
   - 공급자 회사명
   - **매우 중요**: 한글자씩 꼼꼼히 읽어서 오타가 나지 않도록 주의
   - 비슷한 글자 주의사항:
     * ㅁ과 ㅂ 구분 (예: 부석 주식회사 vs 무석 주식회사)
     * ㅇ과 ㅎ 구분 (예: 엔지니어링 vs 헨지니어링)
     * ㅗ와 ㅜ 구분 (예: 코리아 vs 쿠리아)
     * ㅓ와 ㅡ 구분 (예: 터크 vs 트크)
     * ㄱ과 ㄴ 구분 (예: 그룹 vs 느룹)
   - 회사명 앞/뒤 공백 제거
   - 불명확한 글자가 있으면 추측하지 말고 "정보 없음"으로 표시하세요.
   - 일반적인 회사명 패턴 참고 (주식회사, 유한회사, 협동조합 등)

5. **작성일자**: 
   - 세금계산서 작성일자
   - 형태: YYYY-MM-DD 형식으로 통일
   - 입력 형식: YYYY.MM.DD, YYYY/MM/DD 등 다양할 수 있음

6. **공급자등록번호**: 
   - 공급자 사업자등록번호
   - 형태: XXX-XX-XXXXX (하이픈 포함)
   - 숫자만 있는 경우 적절한 위치에 하이픈 추가

7. **공급받는자등록번호**: 
   - 공급받는자 사업자등록번호
   - 형태: XXX-XX-XXXXX (하이픈 포함)
   - 숫자만 있는 경우 적절한 위치에 하이픈 추가

8. **파일명**: "{file_name}"

9. **페이지번호**: {page_number if page_number is not None else "실제 파일의 페이지 번호 (예: 1, 2, 3...)"}

**공급자상호 추출 특별 지침:**
1. **정확성 최우선**: 공급자상호는 가장 중요한 정보이므로 절대 추측하지 말고 보이는 그대로 읽기
2. **한글자씩 확인**: 각 글자를 개별적으로 확인하여 비슷한 모양의 글자와 혼동하지 않기
3. **일반적 패턴 활용**: 
   - "주식회사", "유한회사", "(주)", "(유)" 등 일반적인 회사 형태 확인
   - 업종별 일반적인 단어들 참고 (엔지니어링, 테크놀로지, 코리아, 인더스트리 등)
4. **문맥 고려**: 사업자등록번호, 업종과 연관지어 합리적인 회사명인지 검토
5. **특수문자 주의**: 괄호, 하이픈, 점 등의 특수문자도 정확히 포함
6. OCR 또는 이미지 인식이 어려운 경우, 다른 필드보다 **가장 정확하게 시각적으로 확인**해야 하는 필드입니다.
   잘못된 유추나 추측을 하지 말고, 이미지에 보이는 글자를 하나하나 읽어주세요.

**데이터 검증 및 품질 관리:**
1. **승인번호 검증**: 숫자로만 구성되어 있는지 확인
2. **금액 검증**: 공급가액과 부가세액이 숫자인지 확인
3. **날짜 형식 통일**: 모든 날짜는 YYYY-MM-DD 형식으로 출력
4. **사업자등록번호 형식**: XXX-XX-XXXXX 형식으로 통일
5. **공급자상호 검증**: 한글, 영문, 숫자, 특수문자 조합이 자연스러운지 확인

**오류 방지 체크리스트:**
- [ ] 공급자상호를 한글자씩 꼼꼼히 확인했는가?
- [ ] 비슷한 한글 자모음을 정확히 구분했는가?
- [ ] 공급가액과 합계금액을 구분했는가?
- [ ] 사업자등록번호에 하이픈이 포함되어 있는가?
- [ ] 날짜 형식이 통일되어 있는가?

**중요한 지침:**
1. **위 9개 필드만 추출하고, 다른 정보는 절대 포함하지 마세요**
2. 승인번호가 다른 세금계산서는 각각 개별 문서로 처리
3. 각 문서마다 페이지 번호를 반드시 포함 (실제 파일의 페이지 번호)
4. 존재하지 않는 정보는 "정보 없음"으로 표시
5. **요청하지 않은 필드는 절대 추가하지 마세요**
6. **문서에 있는 다른 모든 정보는 무시하고 위 9개 필드만 추출하세요**
7. **추가 설명이나 주석 없이 순수한 JSON 배열만 반환하세요**
8. **각 필드명은 정확히 위에 명시된 대로 사용하세요**

**출력 형식:**
- 순수한 JSON 배열만 반환
- 각 세금계산서당 하나의 JSON 객체
- 필드명은 정확히 명시된 대로 사용
- 문자열 값은 쌍따옴표로 감싸기
- 숫자 값(페이지번호)은 쌍따옴표 없이 출력

JSON 형태로 정리해주세요. 예시:
[
  {{
    "승인번호": "202401234567890",
    "공급가액": "1,000,000",
    "부가세액": "100,000",
    "공급자상호": "주식회사 테크놀로지코리아",
    "작성일자": "2024-01-01",
    "공급자등록번호": "123-45-67890",
    "공급받는자등록번호": "098-76-54321",
    "파일명": "{file_name}",
    "페이지번호": {page_number if page_number is not None else 1}
  }}
]
"""